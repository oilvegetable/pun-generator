<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>谐音梗生成器 v0.0.2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        /* 下拉菜单动画 */
        .slide-enter-active, .slide-leave-active { transition: all 0.2s ease; }
        .slide-enter-from, .slide-leave-to { opacity: 0; transform: translateY(-10px); }
        .check-item { transition: all 0.2s; }
        .check-item.active { background-color: #eff6ff; border-color: #3b82f6; }
        /* 隐藏滚动条但允许滚动 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col items-center py-10 px-4" @click="closeDropdown">

<div id="app" class="w-full max-w-5xl space-y-8">

    <div class="text-center space-y-2">
        <h1 class="text-5xl font-black text-slate-900 tracking-tight">谐音梗<span class="text-blue-600">生成器</span></h1>
        <p class="text-slate-500">帮你找到心仪的谐音梗</p>
    </div>

    <div class="bg-white p-6 sm:p-8 shadow-xl rounded-2xl border border-slate-100 relative">

        <button @click.stop="toggleSettings"
                class="absolute top-4 right-4 p-2 text-slate-400 hover:text-blue-600 hover:bg-slate-50 rounded-full transition-all z-20">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </button>

        <transition name="slide">
            <div v-if="showSettingsMenu" @click.stop
                 class="absolute top-14 right-4 w-64 bg-white border border-slate-100 shadow-xl rounded-xl p-4 z-30">
                <div class="space-y-4">
                    <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider border-b border-slate-50 pb-2">生成设置</h3>

                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-slate-700">忽略字符顺序</span>

                        <div class="relative cursor-pointer" @click="settings.ignoreOrder = !settings.ignoreOrder">
                            <div class="w-11 h-6 rounded-full transition-colors duration-200 ease-in-out"
                                 :class="settings.ignoreOrder ? 'bg-blue-600' : 'bg-slate-200'"></div>
                            <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full shadow-sm transition-transform duration-200 ease-in-out"
                                 :class="settings.ignoreOrder ? 'translate-x-5' : 'translate-x-0'"></div>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <form @submit.prevent="generate" class="space-y-8 mt-4">

            <div>
                <input type="text" v-model="inputWord"
                       class="block w-full text-center text-2xl font-bold border-0 border-b-2 border-slate-200 focus:border-blue-500 focus:ring-0 bg-transparent py-3 transition-colors placeholder-slate-300"
                       placeholder="输入词语，如：行程、童杰、皇家">
            </div>

            <div v-if="categoryMap" class="space-y-6">
                <div class="flex items-center justify-between border-b border-slate-100 pb-2">
                    <span class="text-sm font-bold text-slate-600">语料库选择</span>
                    <label class="flex items-center cursor-pointer text-sm text-blue-600 hover:text-blue-800">
                        <input type="checkbox" class="mr-2 rounded text-blue-600 focus:ring-blue-500"
                               :checked="isAllSelected"
                               @change="toggleAll">
                        {{ isAllSelected ? '取消全选' : '全选所有' }}
                    </label>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div v-for="(subTypes, groupName) in categoryMap" :key="groupName" class="space-y-3">
                        <h3 class="font-bold text-slate-700 flex items-center">
                            <span class="w-1 h-5 bg-blue-500 rounded-full mr-2"></span>
                            {{ groupName }}
                        </h3>
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                            <div v-for="type in subTypes" :key="type"
                                 @click="toggleType(type)"
                                 class="check-item cursor-pointer border rounded-md px-3 py-2 text-sm text-center select-none"
                                 :class="selectedTypes.includes(type) ? 'active text-blue-700 font-medium' : 'border-slate-200 text-slate-600 hover:border-slate-300'">
                                {{ type }}
                                <span v-if="selectedTypes.includes(type)" class="ml-1 text-xs text-blue-400 bg-blue-50 px-1 rounded-full">
                                        {{ selectedTypes.indexOf(type) + 1 }}
                                    </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div v-else class="text-center text-gray-400 py-4">正在加载语料库配置...</div>

            <button type="submit" :disabled="!inputWord || selectedTypes.length === 0 || loading"
                    class="w-full py-4 rounded-xl text-lg font-bold text-white bg-blue-600 hover:bg-blue-700 disabled:bg-slate-300 disabled:cursor-not-allowed transition-all shadow-lg shadow-blue-200">
                {{ loading ? '正在头脑风暴...' : '立即生成' }}
            </button>
        </form>
    </div>

    <transition name="fade">
        <div v-if="results" id="results-container" class="space-y-6">
            <div v-for="(allHeaderItems, category) in results" :key="category" v-show="allHeaderItems && allHeaderItems.length > 0"
                 class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">

                <div class="px-6 py-4 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="font-bold text-slate-800">{{ category }}</h3>
                    <div class="space-x-2 text-xs">
                        <span class="text-blue-600 font-bold">
                            展示 {{ Math.min(limitMap[category], allHeaderItems.length) }}
                        </span>
                        <span class="text-slate-400">/</span>
                        <span class="text-slate-500">共 {{ allHeaderItems.length }} 条</span>
                    </div>
                </div>

                <div class="p-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div v-for="(item, index) in allHeaderItems.slice(0, limitMap[category])" :key="index"
                         class="group relative bg-white border border-slate-100 rounded-lg p-4 hover:border-blue-200 hover:shadow-md transition-all">
                        <div class="text-lg text-slate-800 mb-1 group-hover:text-blue-600 transition-colors"
                             v-html="renderPun(item)">
                        </div>
                        <div class="text-xs text-slate-400 truncate">
                            原词：{{ item.origins.join('、') }}
                        </div>
                    </div>
                </div>

                <div v-if="allHeaderItems.length > limitMap[category]"
                     class="px-6 py-4 bg-slate-50 border-t border-slate-100 text-center cursor-pointer hover:bg-slate-100 transition-colors"
                     @click="loadMore(category)">
                    <span class="text-sm font-bold text-blue-600">
                        查看更多 (剩余 {{ allHeaderItems.length - limitMap[category] }} 条) ▼
                    </span>
                </div>
            </div>
        </div>
    </transition>

</div>

<script>
    const { createApp, nextTick } = Vue;

    createApp({
        data() {
            return {
                inputWord: '',
                loading: false,
                categoryMap: null,
                selectedTypes: [],
                results: null,
                allTypesList: [],
                showSettingsMenu: false, // 控制菜单显示
                settings: {
                    ignoreOrder: true
                },
                uiConfig: {
                    initial: 20,
                    step: 40
                },
                // 记录每个分类当前的展示上限
                limitMap: {}
            }
        },
        computed: {
            isAllSelected() {
                return this.allTypesList.length > 0 && this.selectedTypes.length === this.allTypesList.length;
            }
        },
        mounted() {
            this.fetchCategories();
            this.fetchUiConfig();
            // 点击外部关闭菜单
            document.addEventListener('click', this.closeDropdown);
        },
        beforeUnmount() {
            document.removeEventListener('click', this.closeDropdown);
        },
        methods: {
            toggleSettings() {
                this.showSettingsMenu = !this.showSettingsMenu;
            },
            closeDropdown(e) {
                // 点击页面其他地方时关闭菜单
                this.showSettingsMenu = false;
            },
            async fetchUiConfig() {
                try {
                    const res = await fetch('/pun/config');
                    if(res.ok) {
                        const data = await res.json();
                        this.uiConfig.initial = data.initial;
                        this.uiConfig.step = data.step;
                    }
                } catch (e) { console.log("使用默认UI配置"); }
            },
            async fetchCategories() {
                try {
                    const mapRes = await fetch('/pun/categories');
                    this.categoryMap = await mapRes.json();

                    const listRes = await fetch('/pun/types-ordered');
                    this.allTypesList = await listRes.json();

                    const defaultRes = await fetch('/pun/types-default');
                    const defaultList = await defaultRes.json();
                    this.selectedTypes = defaultList.filter(t => this.allTypesList.includes(t));
                } catch (e) {
                    console.error("加载失败", e);
                }
            },
            toggleType(type) {
                const idx = this.selectedTypes.indexOf(type);
                if (idx > -1) {
                    this.selectedTypes.splice(idx, 1);
                } else {
                    this.selectedTypes.push(type);
                }
            },
            toggleAll() {
                if (this.isAllSelected) {
                    this.selectedTypes = [];
                } else {
                    this.selectedTypes = [...this.allTypesList];
                }
            },
            loadMore(category) {
                if (this.limitMap[category]) {
                    this.limitMap[category] += this.uiConfig.step;
                }
            },
            async generate() {
                if (!this.inputWord) return;
                this.loading = true;
                this.results = null;
                this.limitMap = {};

                try {
                    const params = new URLSearchParams();
                    params.append('word', this.inputWord);
                    this.selectedTypes.forEach(t => params.append('types', t));
                    params.append('ignoreOrder', this.settings.ignoreOrder);

                    const response = await fetch(`/pun/generate?${params.toString()}`);
                    const data = await response.json();

                    this.results = data;

                    for (const key in data) {
                        this.limitMap[key] = this.uiConfig.initial;
                    }

                    nextTick(() => {
                        const element = document.getElementById('results-container');
                        if (element) {
                            element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    });

                } catch (error) {
                    console.error(error);
                    alert('生成失败');
                } finally {
                    this.loading = false;
                }
            },
            renderPun(item) {
                const text = item.pun;
                const indices = item.highlights || [];
                let html = '';
                for (let i = 0; i < text.length; i++) {
                    const char = text[i];
                    if (indices.includes(i)) {
                        html += `<span class="text-red-500 font-bold text-xl">${char}</span>`;
                    } else {
                        html += char;
                    }
                }
                return html;
            }
        }
    }).mount('#app');
</script>
</body>
</html>